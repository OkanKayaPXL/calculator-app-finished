name: test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4  # required to get repo files on runner [web:52]

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm                 # lockfile-based npm cache [web:52]

      - name: Install dependencies
        run: npm install            # switch to npm ci once lockfile is fixed [web:52]

      - name: Run unit tests with coverage
        run: |
          npm test -- --coverage    # Jest writes coverage/* including lcov.info by default [web:113][web:116]

      - name: Bundle ZIP (app + node_modules)
        run: |
          zip -r app-bundle.zip . \
            -x ".git/*" ".github/*" "node_modules/.cache/*" "*.log"
        # Produces app-bundle.zip at repo root


      # Better code coverage reporting (default settings)
      # This action auto-detects common formats (LCOV/Clover) from coverage/*, no extra inputs needed
      - name: Coverage summary
        uses: dorny/test-reporter@v2
        if: success() || failure()
        # Default behavior reads coverage/lcov.info or Clover files, and writes a rich summary to the run [web:116][web:114]
